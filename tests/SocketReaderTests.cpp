#include "gtest/gtest.h"

#ifdef WIN32

#define TEST_FILE R"(C:\Users\alanc\Documents\cortex\subset.bin)"

#include "../SocketReader.h"
#include "TestSocketServer.h"

class SocketReaderTestSuite : public ::testing::Test {
private:
    std::thread server_thread;
protected:
    void TearDown() override {
        server_thread.join();
    }
public:
    SocketReaderTestSuite()
    : server_thread(emulate_socket_server, TEST_FILE, 1) {}
};

TEST_F(SocketReaderTestSuite, TestSocketRead) {
    short *buf = (short *)malloc(385 * sizeof(short));

    SocketReader<short> reader{};
    reader.connect(SOCKET_PORT);
    auto nbytes_read = reader.read((char *)buf, 385 * sizeof(short));

    EXPECT_EQ(385 * sizeof(short), nbytes_read);
    EXPECT_EQ(-1, buf[0]);
    EXPECT_EQ(9, buf[1]);
    EXPECT_EQ(-10, buf[2]);
    EXPECT_EQ(-6, buf[3]);
    EXPECT_EQ(-2, buf[4]);
    EXPECT_EQ(-4, buf[5]);
    EXPECT_EQ(-9, buf[6]);
    EXPECT_EQ(-1, buf[7]);
    EXPECT_EQ(-3, buf[8]);
    EXPECT_EQ(-5, buf[9]);
    EXPECT_EQ(3, buf[10]);
    EXPECT_EQ(-5, buf[11]);
    EXPECT_EQ(4, buf[12]);
    EXPECT_EQ(-2, buf[13]);
    EXPECT_EQ(-4, buf[14]);
    EXPECT_EQ(2, buf[15]);
    EXPECT_EQ(-1, buf[16]);
    EXPECT_EQ(-7, buf[17]);
    EXPECT_EQ(3, buf[18]);
    EXPECT_EQ(-5, buf[19]);
    EXPECT_EQ(6, buf[20]);
    EXPECT_EQ(-2, buf[21]);
    EXPECT_EQ(2, buf[22]);
    EXPECT_EQ(2, buf[23]);
    EXPECT_EQ(2, buf[24]);
    EXPECT_EQ(-4, buf[25]);
    EXPECT_EQ(-12, buf[26]);
    EXPECT_EQ(-9, buf[27]);
    EXPECT_EQ(1, buf[28]);
    EXPECT_EQ(-4, buf[29]);
    EXPECT_EQ(-2, buf[30]);
    EXPECT_EQ(-6, buf[31]);
    EXPECT_EQ(-8, buf[32]);
    EXPECT_EQ(-14, buf[33]);
    EXPECT_EQ(-9, buf[34]);
    EXPECT_EQ(-6, buf[35]);
    EXPECT_EQ(-3, buf[36]);
    EXPECT_EQ(-8, buf[37]);
    EXPECT_EQ(1, buf[38]);
    EXPECT_EQ(-5, buf[39]);
    EXPECT_EQ(-2, buf[40]);
    EXPECT_EQ(-2, buf[41]);
    EXPECT_EQ(-1, buf[42]);
    EXPECT_EQ(-12, buf[43]);
    EXPECT_EQ(-4, buf[44]);
    EXPECT_EQ(-11, buf[45]);
    EXPECT_EQ(-11, buf[46]);
    EXPECT_EQ(-4, buf[47]);
    EXPECT_EQ(-5, buf[48]);
    EXPECT_EQ(-6, buf[49]);
    EXPECT_EQ(-6, buf[50]);
    EXPECT_EQ(-1, buf[51]);
    EXPECT_EQ(-1, buf[52]);
    EXPECT_EQ(-4, buf[53]);
    EXPECT_EQ(-1, buf[54]);
    EXPECT_EQ(1, buf[55]);
    EXPECT_EQ(-2, buf[56]);
    EXPECT_EQ(-1, buf[57]);
    EXPECT_EQ(-10, buf[58]);
    EXPECT_EQ(1, buf[59]);
    EXPECT_EQ(-4, buf[60]);
    EXPECT_EQ(-6, buf[61]);
    EXPECT_EQ(-10, buf[62]);
    EXPECT_EQ(-5, buf[63]);
    EXPECT_EQ(-7, buf[64]);
    EXPECT_EQ(-5, buf[65]);
    EXPECT_EQ(-15, buf[66]);
    EXPECT_EQ(-11, buf[67]);
    EXPECT_EQ(-13, buf[68]);
    EXPECT_EQ(-15, buf[69]);
    EXPECT_EQ(-12, buf[70]);
    EXPECT_EQ(-6, buf[71]);
    EXPECT_EQ(-9, buf[72]);
    EXPECT_EQ(1, buf[73]);
    EXPECT_EQ(-1, buf[74]);
    EXPECT_EQ(1, buf[75]);
    EXPECT_EQ(4, buf[76]);
    EXPECT_EQ(8, buf[77]);
    EXPECT_EQ(3, buf[78]);
    EXPECT_EQ(0, buf[79]);
    EXPECT_EQ(9, buf[80]);
    EXPECT_EQ(-8, buf[81]);
    EXPECT_EQ(2, buf[82]);
    EXPECT_EQ(2, buf[83]);
    EXPECT_EQ(9, buf[84]);
    EXPECT_EQ(-1, buf[85]);
    EXPECT_EQ(0, buf[86]);
    EXPECT_EQ(4, buf[87]);
    EXPECT_EQ(-3, buf[88]);
    EXPECT_EQ(-2, buf[89]);
    EXPECT_EQ(1, buf[90]);
    EXPECT_EQ(0, buf[91]);
    EXPECT_EQ(4, buf[92]);
    EXPECT_EQ(4, buf[93]);
    EXPECT_EQ(2, buf[94]);
    EXPECT_EQ(4, buf[95]);
    EXPECT_EQ(12, buf[96]);
    EXPECT_EQ(6, buf[97]);
    EXPECT_EQ(20, buf[98]);
    EXPECT_EQ(6, buf[99]);
    EXPECT_EQ(11, buf[100]);
    EXPECT_EQ(4, buf[101]);
    EXPECT_EQ(8, buf[102]);
    EXPECT_EQ(14, buf[103]);
    EXPECT_EQ(0, buf[104]);
    EXPECT_EQ(0, buf[105]);
    EXPECT_EQ(10, buf[106]);
    EXPECT_EQ(4, buf[107]);
    EXPECT_EQ(-3, buf[108]);
    EXPECT_EQ(-8, buf[109]);
    EXPECT_EQ(-7, buf[110]);
    EXPECT_EQ(-3, buf[111]);
    EXPECT_EQ(-5, buf[112]);
    EXPECT_EQ(-2, buf[113]);
    EXPECT_EQ(-5, buf[114]);
    EXPECT_EQ(-3, buf[115]);
    EXPECT_EQ(-9, buf[116]);
    EXPECT_EQ(-3, buf[117]);
    EXPECT_EQ(-3, buf[118]);
    EXPECT_EQ(1, buf[119]);
    EXPECT_EQ(2, buf[120]);
    EXPECT_EQ(0, buf[121]);
    EXPECT_EQ(-1, buf[122]);
    EXPECT_EQ(0, buf[123]);
    EXPECT_EQ(-2, buf[124]);
    EXPECT_EQ(-5, buf[125]);
    EXPECT_EQ(5, buf[126]);
    EXPECT_EQ(6, buf[127]);
    EXPECT_EQ(-4, buf[128]);
    EXPECT_EQ(3, buf[129]);
    EXPECT_EQ(6, buf[130]);
    EXPECT_EQ(3, buf[131]);
    EXPECT_EQ(2, buf[132]);
    EXPECT_EQ(-2, buf[133]);
    EXPECT_EQ(0, buf[134]);
    EXPECT_EQ(5, buf[135]);
    EXPECT_EQ(5, buf[136]);
    EXPECT_EQ(0, buf[137]);
    EXPECT_EQ(1, buf[138]);
    EXPECT_EQ(1, buf[139]);
    EXPECT_EQ(-3, buf[140]);
    EXPECT_EQ(-1, buf[141]);
    EXPECT_EQ(6, buf[142]);
    EXPECT_EQ(9, buf[143]);
    EXPECT_EQ(5, buf[144]);
    EXPECT_EQ(0, buf[145]);
    EXPECT_EQ(10, buf[146]);
    EXPECT_EQ(5, buf[147]);
    EXPECT_EQ(5, buf[148]);
    EXPECT_EQ(1, buf[149]);
    EXPECT_EQ(3, buf[150]);
    EXPECT_EQ(2, buf[151]);
    EXPECT_EQ(-4, buf[152]);
    EXPECT_EQ(5, buf[153]);
    EXPECT_EQ(-4, buf[154]);
    EXPECT_EQ(-3, buf[155]);
    EXPECT_EQ(-1, buf[156]);
    EXPECT_EQ(3, buf[157]);
    EXPECT_EQ(-5, buf[158]);
    EXPECT_EQ(8, buf[159]);
    EXPECT_EQ(-3, buf[160]);
    EXPECT_EQ(-6, buf[161]);
    EXPECT_EQ(5, buf[162]);
    EXPECT_EQ(6, buf[163]);
    EXPECT_EQ(7, buf[164]);
    EXPECT_EQ(3, buf[165]);
    EXPECT_EQ(-4, buf[166]);
    EXPECT_EQ(-1, buf[167]);
    EXPECT_EQ(8, buf[168]);
    EXPECT_EQ(6, buf[169]);
    EXPECT_EQ(7, buf[170]);
    EXPECT_EQ(0, buf[171]);
    EXPECT_EQ(1, buf[172]);
    EXPECT_EQ(-2, buf[173]);
    EXPECT_EQ(3, buf[174]);
    EXPECT_EQ(8, buf[175]);
    EXPECT_EQ(2, buf[176]);
    EXPECT_EQ(-2, buf[177]);
    EXPECT_EQ(9, buf[178]);
    EXPECT_EQ(0, buf[179]);
    EXPECT_EQ(4, buf[180]);
    EXPECT_EQ(-1, buf[181]);
    EXPECT_EQ(-2, buf[182]);
    EXPECT_EQ(-1, buf[183]);
    EXPECT_EQ(7, buf[184]);
    EXPECT_EQ(7, buf[185]);
    EXPECT_EQ(12, buf[186]);
    EXPECT_EQ(3, buf[187]);
    EXPECT_EQ(1, buf[188]);
    EXPECT_EQ(5, buf[189]);
    EXPECT_EQ(4, buf[190]);
    EXPECT_EQ(-3, buf[191]);
    EXPECT_EQ(2, buf[192]);
    EXPECT_EQ(-1, buf[193]);
    EXPECT_EQ(9, buf[194]);
    EXPECT_EQ(-2, buf[195]);
    EXPECT_EQ(-9, buf[196]);
    EXPECT_EQ(-2, buf[197]);
    EXPECT_EQ(-1, buf[198]);
    EXPECT_EQ(8, buf[199]);
    EXPECT_EQ(5, buf[200]);
    EXPECT_EQ(2, buf[201]);
    EXPECT_EQ(2, buf[202]);
    EXPECT_EQ(1, buf[203]);
    EXPECT_EQ(12, buf[204]);
    EXPECT_EQ(3, buf[205]);
    EXPECT_EQ(7, buf[206]);
    EXPECT_EQ(6, buf[207]);
    EXPECT_EQ(-1, buf[208]);
    EXPECT_EQ(-7, buf[209]);
    EXPECT_EQ(-7, buf[210]);
    EXPECT_EQ(-1, buf[211]);
    EXPECT_EQ(4, buf[212]);
    EXPECT_EQ(-2, buf[213]);
    EXPECT_EQ(2, buf[214]);
    EXPECT_EQ(3, buf[215]);
    EXPECT_EQ(3, buf[216]);
    EXPECT_EQ(-2, buf[217]);
    EXPECT_EQ(-3, buf[218]);
    EXPECT_EQ(-1, buf[219]);
    EXPECT_EQ(-6, buf[220]);
    EXPECT_EQ(2, buf[221]);
    EXPECT_EQ(4, buf[222]);
    EXPECT_EQ(3, buf[223]);
    EXPECT_EQ(5, buf[224]);
    EXPECT_EQ(-7, buf[225]);
    EXPECT_EQ(0, buf[226]);
    EXPECT_EQ(0, buf[227]);
    EXPECT_EQ(2, buf[228]);
    EXPECT_EQ(2, buf[229]);
    EXPECT_EQ(-1, buf[230]);
    EXPECT_EQ(-1, buf[231]);
    EXPECT_EQ(-2, buf[232]);
    EXPECT_EQ(0, buf[233]);
    EXPECT_EQ(3, buf[234]);
    EXPECT_EQ(-4, buf[235]);
    EXPECT_EQ(1, buf[236]);
    EXPECT_EQ(8, buf[237]);
    EXPECT_EQ(-1, buf[238]);
    EXPECT_EQ(1, buf[239]);
    EXPECT_EQ(3, buf[240]);
    EXPECT_EQ(-3, buf[241]);
    EXPECT_EQ(2, buf[242]);
    EXPECT_EQ(-4, buf[243]);
    EXPECT_EQ(5, buf[244]);
    EXPECT_EQ(-2, buf[245]);
    EXPECT_EQ(0, buf[246]);
    EXPECT_EQ(3, buf[247]);
    EXPECT_EQ(4, buf[248]);
    EXPECT_EQ(-1, buf[249]);
    EXPECT_EQ(-6, buf[250]);
    EXPECT_EQ(1, buf[251]);
    EXPECT_EQ(4, buf[252]);
    EXPECT_EQ(2, buf[253]);
    EXPECT_EQ(-2, buf[254]);
    EXPECT_EQ(-1, buf[255]);
    EXPECT_EQ(6, buf[256]);
    EXPECT_EQ(6, buf[257]);
    EXPECT_EQ(-1, buf[258]);
    EXPECT_EQ(0, buf[259]);
    EXPECT_EQ(-2, buf[260]);
    EXPECT_EQ(8, buf[261]);
    EXPECT_EQ(6, buf[262]);
    EXPECT_EQ(0, buf[263]);
    EXPECT_EQ(-1, buf[264]);
    EXPECT_EQ(12, buf[265]);
    EXPECT_EQ(9, buf[266]);
    EXPECT_EQ(-1, buf[267]);
    EXPECT_EQ(-3, buf[268]);
    EXPECT_EQ(-1, buf[269]);
    EXPECT_EQ(-10, buf[270]);
    EXPECT_EQ(-2, buf[271]);
    EXPECT_EQ(-1, buf[272]);
    EXPECT_EQ(1, buf[273]);
    EXPECT_EQ(1, buf[274]);
    EXPECT_EQ(-6, buf[275]);
    EXPECT_EQ(-4, buf[276]);
    EXPECT_EQ(-4, buf[277]);
    EXPECT_EQ(-14, buf[278]);
    EXPECT_EQ(-2, buf[279]);
    EXPECT_EQ(-1, buf[280]);
    EXPECT_EQ(-1, buf[281]);
    EXPECT_EQ(-8, buf[282]);
    EXPECT_EQ(5, buf[283]);
    EXPECT_EQ(-3, buf[284]);
    EXPECT_EQ(-6, buf[285]);
    EXPECT_EQ(8, buf[286]);
    EXPECT_EQ(1, buf[287]);
    EXPECT_EQ(-1, buf[288]);
    EXPECT_EQ(-1, buf[289]);
    EXPECT_EQ(-2, buf[290]);
    EXPECT_EQ(-1, buf[291]);
    EXPECT_EQ(0, buf[292]);
    EXPECT_EQ(-2, buf[293]);
    EXPECT_EQ(4, buf[294]);
    EXPECT_EQ(-2, buf[295]);
    EXPECT_EQ(-2, buf[296]);
    EXPECT_EQ(-3, buf[297]);
    EXPECT_EQ(1, buf[298]);
    EXPECT_EQ(1, buf[299]);
    EXPECT_EQ(2, buf[300]);
    EXPECT_EQ(2, buf[301]);
    EXPECT_EQ(-5, buf[302]);
    EXPECT_EQ(-3, buf[303]);
    EXPECT_EQ(1, buf[304]);
    EXPECT_EQ(1, buf[305]);
    EXPECT_EQ(6, buf[306]);
    EXPECT_EQ(8, buf[307]);
    EXPECT_EQ(0, buf[308]);
    EXPECT_EQ(7, buf[309]);
    EXPECT_EQ(3, buf[310]);
    EXPECT_EQ(0, buf[311]);
    EXPECT_EQ(5, buf[312]);
    EXPECT_EQ(1, buf[313]);
    EXPECT_EQ(1, buf[314]);
    EXPECT_EQ(7, buf[315]);
    EXPECT_EQ(6, buf[316]);
    EXPECT_EQ(2, buf[317]);
    EXPECT_EQ(3, buf[318]);
    EXPECT_EQ(3, buf[319]);
    EXPECT_EQ(10, buf[320]);
    EXPECT_EQ(6, buf[321]);
    EXPECT_EQ(6, buf[322]);
    EXPECT_EQ(5, buf[323]);
    EXPECT_EQ(4, buf[324]);
    EXPECT_EQ(22, buf[325]);
    EXPECT_EQ(9, buf[326]);
    EXPECT_EQ(1, buf[327]);
    EXPECT_EQ(12, buf[328]);
    EXPECT_EQ(22, buf[329]);
    EXPECT_EQ(26, buf[330]);
    EXPECT_EQ(19, buf[331]);
    EXPECT_EQ(29, buf[332]);
    EXPECT_EQ(18, buf[333]);
    EXPECT_EQ(33, buf[334]);
    EXPECT_EQ(26, buf[335]);
    EXPECT_EQ(33, buf[336]);
    EXPECT_EQ(10, buf[337]);
    EXPECT_EQ(37, buf[338]);
    EXPECT_EQ(13, buf[339]);
    EXPECT_EQ(0, buf[340]);
    EXPECT_EQ(3, buf[341]);
    EXPECT_EQ(21, buf[342]);
    EXPECT_EQ(-4, buf[343]);
    EXPECT_EQ(-1, buf[344]);
    EXPECT_EQ(-5, buf[345]);
    EXPECT_EQ(3, buf[346]);
    EXPECT_EQ(-6, buf[347]);
    EXPECT_EQ(-1, buf[348]);
    EXPECT_EQ(-9, buf[349]);
    EXPECT_EQ(-7, buf[350]);
    EXPECT_EQ(0, buf[351]);
    EXPECT_EQ(-7, buf[352]);
    EXPECT_EQ(-2, buf[353]);
    EXPECT_EQ(-11, buf[354]);
    EXPECT_EQ(-7, buf[355]);
    EXPECT_EQ(0, buf[356]);
    EXPECT_EQ(-10, buf[357]);
    EXPECT_EQ(-5, buf[358]);
    EXPECT_EQ(1, buf[359]);
    EXPECT_EQ(0, buf[360]);
    EXPECT_EQ(6, buf[361]);
    EXPECT_EQ(6, buf[362]);
    EXPECT_EQ(2, buf[363]);
    EXPECT_EQ(1, buf[364]);
    EXPECT_EQ(6, buf[365]);
    EXPECT_EQ(3, buf[366]);
    EXPECT_EQ(2, buf[367]);
    EXPECT_EQ(-11, buf[368]);
    EXPECT_EQ(3, buf[369]);
    EXPECT_EQ(-15, buf[370]);
    EXPECT_EQ(-3, buf[371]);
    EXPECT_EQ(-6, buf[372]);
    EXPECT_EQ(-5, buf[373]);
    EXPECT_EQ(-7, buf[374]);
    EXPECT_EQ(-5, buf[375]);
    EXPECT_EQ(-2, buf[376]);
    EXPECT_EQ(-2, buf[377]);
    EXPECT_EQ(-2, buf[378]);
    EXPECT_EQ(1, buf[379]);
    EXPECT_EQ(1, buf[380]);
    EXPECT_EQ(-1, buf[381]);
    EXPECT_EQ(8, buf[382]);
    EXPECT_EQ(4, buf[383]);
    EXPECT_EQ(-1, buf[384]);

    free(buf);
}

#endif
